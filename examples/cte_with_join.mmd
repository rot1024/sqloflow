flowchart LR
    subgraph cte_recent_max [CTE: recent_max]
        direction TB
        node_3["SELECT customer_id, MAX(total_amount) AS max_total"]
        node_2["GROUP BY customer_id"]
        node_1["WHERE created_at &gt;= CURRENT_DATE() - INTERVAL &#39;30 days&#39;"]
        node_0[FROM orders]
        node_0 --> node_1
        node_1 --> node_2
        node_2 --> node_3
    end

    node_5[FROM orders AS o]
    node_6["INNER JOIN INNER JOIN recent_max AS r ON r.customer_id = o.customer_id"]
    node_7["WHERE o.total_amount = r.max_total"]
    node_8["SELECT o.id, o.total_amount"]
    node_3 -->|CTE result| node_4
    node_5 --> node_6
    node_6 --> node_7
    node_7 --> node_8