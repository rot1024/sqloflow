┌─────────────┐         ┌─────────────────────────────────────────────────────────┐                   ┌──────────────────────┐                  ┌────────────────────────────────────────────────────┐    ┌─────────────────┐ 
│ FROM orders │────────▶│ WHERE created_at >= CURRENT_DATE() - INTERVAL '30 days' │──────────────────▶│ GROUP BY customer_id │─────────────────▶│ SELECT customer_id, MAX(total_amount) AS max_total │───▶│ CTE: recent_max │ 
└─────────────┘         └─────────────────────────────────────────────────────────┘                   └──────────────────────┘                  └────────────────────────────────────────────────────┘    └─────────────────┘ 
                                                                                                                                                                                                                              
                                                                                                                                                                                                                              
┌──────────────────┐    ┌────────────────────────────────────────────────────────────────────────┐    ┌────────────────────────────────────┐    ┌─────────────────────────────┐                                               
│ FROM orders AS o │───▶│ INNER JOIN INNER JOIN recent_max AS r ON r.customer_id = o.customer_id │───▶│ WHERE o.total_amount = r.max_total │───▶│ SELECT o.id, o.total_amount │                                               
└──────────────────┘    └────────────────────────────────────────────────────────────────────────┘    └────────────────────────────────────┘    └─────────────────────────────┘                                               
                                                                                                                                                                                                                              