digraph sqloflow {
  rankdir=LR;
  node [shape=box, style=rounded];


  subgraph cluster_node_4 {
    label="CTE: recent_max";
    style=filled;
    fillcolor=lightblue;
    color=blue;
    penwidth=2;
    node_3 [label="SELECT customer_id, MAX(total_amount) AS max_total", fillcolor=lightgreen, style="filled,rounded"];
    node_2 [label="GROUP BY customer_id", fillcolor=lightgreen, style="filled,rounded"];
    node_1 [label="WHERE created_at >= CURRENT_DATE() - INTERVAL '30 days'", fillcolor=lightyellow, style="filled,rounded"];
    node_0 [label="FROM orders", fillcolor=lightgreen, style="filled,rounded"];
    node_0 -> node_1 [color=black];
    node_1 -> node_2 [color=black];
    node_2 -> node_3 [color=black];
  }
  // Node definitions
  node_5 [label="FROM orders AS o", fillcolor=lightgreen, style="filled,rounded"];
  node_6 [label="INNER JOIN recent_max AS r ON r.customer_id = o.customer_id", fillcolor=lightgreen, style="filled,rounded"];
  node_8 [label="SELECT o.id, o.total_amount", fillcolor=lightgreen, style="filled,rounded"];
  node_7 [label="WHERE o.total_amount = r.max_total", fillcolor=lightyellow, style="filled,rounded"];

  // Edges
  node_5 -> node_6 [color=black];
  node_3 -> node_6 [color=black];
  node_6 -> node_7 [color=black];
  node_7 -> node_8 [color=black];
}